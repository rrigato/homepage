---
AWSTemplateFormatVersion: "2010-09-09"

Description:
  Importing existing S3 Bucket and Route53 hosted zone to cloudformation
Parameters:

  BucketName:
    Type: String
    Default: ryanrigato.com
    Description: The name for the bucket hosting the static website

  RetainProperty:
    Type: String
    Default: "Retain"
    Description: Whether to retain cf resources when the stack is deleted

Conditions:
  RetainResourcesCreated:
      !Equals [ !Ref BucketName, ryanrigato.com ]

Resources:
  WebsiteBucket:
    Condition: RetainResourcesCreated
    DeletionPolicy: Retain
    Properties:
      BucketName: !Ref BucketName
      LoggingConfiguration:
        DestinationBucketName: !Join
                      - '.'
                      #The second argument is a list
                      - - 'logs'
                        - !Ref BucketName

        LogFilePrefix: root/
      Tags:
          -
              Key: websiteReason
              Value: portfolio
          -
              Key: use
              Value: website
      VersioningConfiguration:
        Status: Enabled
      WebsiteConfiguration:
        IndexDocument: index.html
    Type: "AWS::S3::Bucket"


  StaticWebpageCdn:
    DependsOn: CloudFrontOai
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: CDN for S3-backed website
        #Essientially a cname record to
        #what you want your url name to be
        Aliases:
          - 'test.ryanrigato.com'
        Enabled: true
        DefaultCacheBehavior:
          ForwardedValues:
            QueryString: true
          TargetOriginId: only-origin
          ViewerProtocolPolicy: redirect-to-https
        DefaultRootObject: index.html
        #Origin is an S3 bucket
        Origins:
          - DomainName: 'www.ryanrigato.s3.amazonaws.com'
            Id: only-origin
            S3OriginConfig:
                OriginAccessIdentity: '' #!Sub "origin-access-identity/cloudfront/${CloudFrontOai}"
        ViewerCertificate:
          AcmCertificateArn: arn:aws:acm:us-east-1:972323850308:certificate/111bbdc6-2f76-4b67-adf7-393f6391e6e7
              # !Join ['', ['arn:aws:acm:us-east-1:',
              # !Ref AWS::AccountId,
              # ':certificate/111bbdc6-2f76-4b67-adf7-393f6391e6e7']]
          #Server Name Identification (SNI) =
          #Allow cloudfront edge servers to
          #present multiple ssl certs to client, this is
          #lower cost than having only 1 ssl cert per CloudFront
          #point of prescense
          SslSupportMethod: sni-only
        #lowest price class
        PriceClass: PriceClass_100

  CloudFrontOai:
    Type: AWS::CloudFront::CloudFrontOriginAccessIdentity
    Properties:
      CloudFrontOriginAccessIdentityConfig:
        Comment: OAI to ensure S3 bucket can only be accessed from distribution
